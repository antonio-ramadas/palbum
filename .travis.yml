git:
    depth: false # It is not performed any git operation. So, it is only required the last/current commit

before_cache:
    - rm -rf $HOME/.cache/electron-builder/wine

cache:
    directories:
        - $HOME/.npm
        - node_modules
        - $HOME/.cache/electron
        - $HOME/.cache/electron-builder
matrix:
    include:
        - os: osx
          osx_image: xcode9.4
          language: node_js
          node_js: "8"
          env:
              - ELECTRON_CACHE=$HOME/.cache/electron
              - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder

        - os: linux
          services: docker
          language: generic

jobs:
    include:
        - stage: test
          os: osx # Lint is only required in one OS (does not matter which one)
          language: node_js
          install: npm ci
          script: npm run lint -s

        - stage: build
          if: branch = master
          install: skip
          script:
              - |
                if [ "$TRAVIS_OS_NAME" == "linux" ]; then
                  docker run --rm \
                    --env-file <(env | grep -iE 'DEBUG|NODE_|ELECTRON_|YARN_|NPM_|CI|CIRCLE|TRAVIS|APPVEYOR_|CSC_|_TOKEN|_KEY|AWS_|STRIP|BUILD_') \
                    -v ${PWD}:/project \
                    -v ~/.cache/electron:/root/.cache/electron \
                    -v ~/.cache/electron-builder:/root/.cache/electron-builder \
                    electronuserland/builder:wine \
                    /bin/bash -c "npm ci && npm run electron-pack -- --linux --win"
                else
                    npm ci && npm run electron-pack
                fi

          # TODO add deployment/publish state
        #- stage: deploy
          #if: branch = master AND type != pull_request # build only on master if it is not a Pull Request
          #script: skip # Prevent running the default test script
          #deploy: # TODO deploy to GitHub
